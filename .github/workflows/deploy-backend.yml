name: Deploy Backend to AWS

on:
  push:
    branches: [ "main", "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Deploy to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            set -e
            sudo apt-get update
            sudo apt-get install -y software-properties-common
            sudo add-apt-repository ppa:ondrej/php -y
            sudo apt-get update
            sudo apt-get install -y php8.4-cli php8.4-fpm php8.4-mysql php8.4-xml php8.4-curl php8.4-mbstring php8.4-zip php8.4-bcmath php8.4-intl unzip nginx git
            
            # Use PHP 8.4 specifically
            PHP_VERSION="8.4"
            echo "Using PHP version: $PHP_VERSION"

            # Setup project directory
            sudo mkdir -p /var/www/fireshop
            sudo chown -R ubuntu:ubuntu /var/www/fireshop
            
            cd /var/www/fireshop
            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }} .
            else
              git pull origin ${{ github.ref_name }}
            fi

            # --- Install Node.js ---
            if ! [ -x "$(command -v node)" ]; then
              echo "Installing Node.js..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            # --- Frontend Build ---
            echo "Building Frontend..."
            cd frontend
            npm install
            npm run build
            cd ..

            # --- Backend Setup ---
            cd Backend2
            
            # Install Composer
            if ! [ -x "$(command -v composer)" ]; then
              curl -sS https://getcomposer.org/installer | php
              sudo mv composer.phar /usr/local/bin/composer
            fi
            
            composer install --no-dev --optimize-autoloader
            
            # Setup .env
            if [ ! -f ".env" ]; then
              cp .env.example .env
              sed -i "s/APP_DEBUG=false/APP_DEBUG=true/" .env
              sed -i "s|APP_URL=http://localhost|APP_URL=http://${{ secrets.EC2_IP }}|" .env
              sed -i "s/DB_HOST=127.0.0.1/DB_HOST=fireshop-db.cbcqkg8emzwm.ap-south-1.rds.amazonaws.com/" .env
              sed -i "s/DB_DATABASE=laravel/DB_DATABASE=fireshop_db/" .env
              sed -i "s/DB_USERNAME=root/DB_USERNAME=admin/" .env
              sed -i "s/DB_PASSWORD=/DB_PASSWORD=${{ secrets.DB_PASSWORD }}/" .env
              php artisan key:generate
            else
              sed -i "s/APP_DEBUG=false/APP_DEBUG=true/" .env
            fi

            # Fix for subpath hosting: Create a symlink so Nginx 'root' works for /api
            mkdir -p public
            cd public
            ln -sf . api
            cd ..
            
            php artisan migrate --force
            php artisan storage:link
            php artisan config:clear
            php artisan cache:clear
            
            # Refresh permissions
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache
            
            # --- Unified Nginx Config ---
            sudo tee /etc/nginx/sites-available/fireshop <<EOF
            server {
                listen 80;
                server_name ${{ secrets.EC2_IP }};

                # Serve Frontend by default
                root /var/www/fireshop/frontend/dist;
                index index.html;

                location / {
                    try_files \$uri \$uri/ /index.html;
                }

                # Serve Backend API (Standard root + symlink approach)
                location /api {
                    root /var/www/fireshop/Backend2/public;
                    index index.php;
                    try_files \$uri \$uri/ /api/index.php?\$query_string;

                    location ~ \.php\$ {
                        include fastcgi_params;
                        fastcgi_pass unix:/var/run/php/php8.4-fpm.sock;
                        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
                        fastcgi_param REQUEST_URI \$request_uri;
                    }
                }

                # Serve Backend Storage
                location /storage {
                    alias /var/www/fireshop/Backend2/storage/app/public;
                }

                add_header X-Frame-Options "SAMEORIGIN";
                add_header X-Content-Type-Options "nosniff";
                charset utf-8;
            }
            EOF

            sudo ln -sf /etc/nginx/sites-available/fireshop /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t && sudo systemctl reload nginx
